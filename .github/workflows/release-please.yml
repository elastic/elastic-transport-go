name: Release

on:
  push:
    branches:
      - "main"

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  release:
    name: Release Please
    runs-on: ubuntu-latest
    steps:
      - name: Fetch ephemeral GitHub token
        id: fetch-token
        uses: elastic/ci-gh-actions/fetch-github-token@v1.0.0
        with:
            vault-instance: "ci-prod"

      - uses: googleapis/release-please-action@v4
        id: release-please
        with:
            config-file: .github/release-please-config.json
            manifest-file: .github/.release-please-manifest.json
            target-branch: ${{ github.ref_name }}
            token: ${{ steps.fetch-token.outputs.token }}

      - name: Checkout repository
        if: steps.release-please.outputs.release_created == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ steps.fetch-token.outputs.token }}

      - name: Bump Version Snapshot
        id: bump-version
        if: steps.release-please.outputs.release_created == 'true'
        run: |
          NEXT_PATCH=$((${{ steps.release-please.outputs.patch }} + 1))
          NEXT_VERSION="${{ steps.release-please.outputs.major }}.${{ steps.release-please.outputs.minor }}.${NEXT_PATCH}-SNAPSHOT"
          echo "Next version: $NEXT_VERSION"
          sed -i "s/const Version = \".*\"/const Version = \"$NEXT_VERSION\"/" elastictransport/version/version.go
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT


      - name: Create Version Bump Pull Request
        if: steps.release-please.outputs.release_created == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.fetch-token.outputs.token }}
          commit-message: 'chore: bump version to ${{ steps.bump-version.outputs.next_version }}'
          branch: chore/bump-version-${{ steps.bump-version.outputs.next_version }}
          delete-branch: true
          title: 'chore: bump version to ${{ steps.bump-version.outputs.next_version }}'
          body: |
            Bumps version to ${{ steps.bump-version.outputs.next_version }} after release ${{ steps.release-please.outputs.major }}.${{ steps.release-please.outputs.minor }}.${{ steps.release-please.outputs.patch }}.
            
            Auto-generated by GitHub Actions.
          base: ${{ github.ref_name }}
          committer: 'Elastic Machine <elasticmachine@users.noreply.github.com>'
          author: 'Elastic Machine <elasticmachine@users.noreply.github.com>'
